<%- include('../../views/partials/admin/header') %>

<div class="wrapper">
  <%- include('../../views/partials/admin/sidebar', { activePage: activePage || 'orders' }) %>

  <div class="container mt-4">
    <div class="text-center">
      <h1>Order Details</h1>
      <% if(orderDetails.orderNumber) { %>
      <h5>Order Number: <%= orderDetails.orderNumber %></h5>
      <% } %>
    </div>

    <!-- Order Information Card -->
    <div class="order-info mb-4 p-4 border rounded shadow-sm">
      <h4 class="mb-3">Order Information</h4>
      <div class="row">
        <div class="col-md-6">
          <p><strong>Order ID:</strong> <%= orderDetails.orderId %></p>
          <p><strong>Payment Method:</strong> <%= orderDetails.paymentMethod %></p>
          <p><strong>User Name:</strong> <%= orderDetails.Id.name %></p>
          <p><strong>Status:</strong>
            <span class="badge bg-<%=
              orderDetails.status === 'Delivered' ? 'success' :
              orderDetails.status === 'Processing' ? 'info' :
              orderDetails.status === 'Shipped' ? 'primary' :
              orderDetails.status === 'Cancelled' ? 'danger' :
              orderDetails.status === 'Returned' ? 'warning' : 'secondary'
            %>">
              <%= orderDetails.status %>
            </span>
          </p>
          <p><strong>Coupon Applied:</strong>
            <span class="badge bg-<%= orderDetails.couponApplied ? 'success' : 'secondary' %>">
              <%= orderDetails.couponApplied ? 'Yes' : 'No' %>
            </span>
          </p>
        </div>
        <div class="col-md-6">
          <p><strong>Total Price:</strong> &#8377;<%= orderDetails.totalPrice.toFixed(2) %></p>
          <p><strong>Discount:</strong> &#8377;<%= orderDetails.discount.toFixed(2) %></p>
          <p><strong>Final Amount:</strong> &#8377;<%= orderDetails.finalAmount.toFixed(2) %></p>
          <p><strong>Money Sent to Wallet:</strong>
            <span class="badge bg-<%= orderDetails.moneySent ? 'success' : 'warning' %>">
              <%= orderDetails.moneySent ? 'Yes' : 'No' %>
            </span>
          </p>
          <p><strong>Order Date:</strong> <%= new Date(orderDetails.createdOn).toLocaleString() %></p>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons text-center mb-4 p-4 border rounded bg-light">
      <h5 class="mb-3">Order Actions</h5>
      <div class="d-flex flex-wrap justify-content-center gap-2">
        <% if (orderDetails.status === 'Order Placed') { %>
        <button class="btn btn-info status-btn" data-id="<%= orderDetails.orderId %>" data-status="Processing">Process Order</button>
        <% } else if (orderDetails.status === 'Processing') { %>
        <button class="btn btn-primary status-btn" data-id="<%= orderDetails.orderId %>" data-status="Shipped">Ship Order</button>
        <% } else if (orderDetails.status === 'Shipped') { %>
        <button class="btn btn-success status-btn" data-id="<%= orderDetails.orderId %>" data-status="Delivered">Mark as Delivered</button>
        <% } else if (orderDetails.status === 'Delivered') { %>
        <button class="btn btn-warning status-btn" data-id="<%= orderDetails.orderId %>" data-status="Return Request">Mark as Return Request</button>
        <% } else if (orderDetails.status === 'Return Request') { %>
        <button class="btn btn-danger status-btn" data-id="<%= orderDetails.orderId %>" data-status="Returned">Mark as Returned</button>
        <% } %>

        <!-- Cancel Order Button (only if not already cancelled/returned) -->
        <% if (orderDetails.status !== 'Cancelled' && orderDetails.status !== 'Returned' && orderDetails.status !== 'Delivered') { %>
        <button class="btn btn-danger status-btn" data-id="<%= orderDetails.orderId %>" data-status="Cancelled">Cancel Entire Order</button>
        <% } %>
      </div>

      <!-- Wallet Actions -->
      <% if (orderDetails.status === 'Cancelled') { %>
      <div class="mt-3 pt-3 border-top">
        <h6>Wallet Actions</h6>
        <% if ((orderDetails.paymentMethod === 'prepaid' || orderDetails.paymentMethod === 'wallet') && !orderDetails.moneySent) { %>
        <button class="btn btn-primary send-money-btn" data-id="<%= orderDetails.orderId %>">Send Money to Wallet</button>
        <% } else if ((orderDetails.paymentMethod === 'prepaid' || orderDetails.paymentMethod === 'wallet') && orderDetails.moneySent) { %>
        <p class="text-success mt-2"><i class="fas fa-check-circle"></i> Money has been sent to user's wallet</p>
        <% } else if (orderDetails.paymentMethod === 'COD') { %>
        <p class="text-muted mt-2"><i class="fas fa-info-circle"></i> COD order - No refund required</p>
        <% } %>
      </div>
      <% } %>
    </div>

    <!-- Address Information -->
    <div class="address-info mb-4 p-4 border rounded shadow-sm">
      <h4 class="mb-3">Shipping Address</h4>
      <% if(orderDetails.address) { %>
      <div class="row">
        <div class="col-md-6">
          <p><strong>Name:</strong> <%= orderDetails.address.name %></p>
          <p><strong>City:</strong> <%= orderDetails.address.city %></p>
          <p><strong>Landmark:</strong> <%= orderDetails.address.landMark || 'N/A' %></p>
        </div>
        <div class="col-md-6">
          <p><strong>State:</strong> <%= orderDetails.address.state %></p>
          <p><strong>Pincode:</strong> <%= orderDetails.address.pincode %></p>
          <p><strong>Phone:</strong> <%= orderDetails.address.phone %></p>
          <% if (orderDetails.address.altPhone) { %>
          <p><strong>Alternate Phone:</strong> <%= orderDetails.address.altPhone %></p>
          <% } %>
        </div>
      </div>
      <% } else { %>
      <p>No Address found.</p>
      <% } %>
    </div>

    <!-- Ordered Items with Individual Actions -->
    <div class="ordered-items mb-4">
      <h4 class="mb-3">Ordered Items</h4>
      <div class="table-responsive">
        <table class="table table-bordered table-striped">
          <thead class="table-dark">
            <tr>
              <th>Product Image</th>
              <th>Product Name</th>
              <th>Price</th>
              <th>Quantity</th>
              <th>Item Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% orderDetails.orderedItems.forEach((item, index) => {
              const isCancelled = item.status === 'cancelled';
              const canCancel = !isCancelled &&
                orderDetails.status !== 'Cancelled' &&
                orderDetails.status !== 'Returned' &&
                orderDetails.status !== 'Delivered' &&
                orderDetails.status !== 'Shipped';
            %>
            <tr class="<%= isCancelled ? 'table-secondary' : '' %>">
              <td>
                <img src="<%= item.product.productImage[0] %>" alt="<%= item.product.productName %>" width="80" class="img-fluid rounded shadow-sm">
              </td>
              <td>
                <strong><%= item.product.productName %></strong>
                <% if (item.cancellationReason) { %>
                <br>
                <small class="text-danger">
                  <strong>Cancellation Reason:</strong> <%= item.cancellationReason %>
                </small>
                <% } %>
              </td>
              <td>&#8377;<%= item.price.toFixed(2) %></td>
              <td><%= item.quantity %></td>
              <td>
                <span class="badge bg-<%=
                  item.status === 'cancelled' ? 'danger' :
                  item.status === 'delivered' ? 'success' :
                  item.status === 'shipped' ? 'primary' : 'info'
                %>">
                  <%= item.status ? item.status.charAt(0).toUpperCase() + item.status.slice(1) : 'Ordered' %>
                </span>
              </td>
              <td>
                <% if (canCancel) { %>
                <button class="btn btn-sm btn-outline-danger cancel-item-btn" data-order-id="<%= orderDetails.orderId %>" data-item-id="<%= item._id %>" data-product-name="<%= item.product.productName %>">
                  <i class="fas fa-times"></i> Cancel Item
                </button>
                <% } else if (isCancelled) { %>
                <span class="text-muted">Cancelled</span>
                <% } else { %>
                <span class="text-muted">No actions available</span>
                <% } %>
              </td>
            </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

      <!-- Order Summary -->
      <div class="row mt-4">
        <div class="col-md-6">
          <div class="card border-primary">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0">Order Summary</h5>
            </div>
            <div class="card-body">
              <!-- Original Order -->
              <div class="mb-3">
                <h6><i class="fas fa-shopping-cart"></i> Original Order</h6>
                <div class="d-flex justify-content-between mb-2">
                  <span>Original Total:</span>
                  <strong>&#8377;<%= orderDetails.originalTotalPrice.toFixed(2) %></strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                  <span>Original Discount:</span>
                  <strong class="text-danger">-&#8377;<%= orderDetails.originalDiscount.toFixed(2) %></strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                  <span>Original Final Amount:</span>
                  <strong class="text-success">&#8377;<%= orderDetails.originalFinalAmount.toFixed(2) %></strong>
                </div>
              </div>

              <hr>

              <!-- Current Order (After Cancellations) -->
              <div class="mt-3">
                <h6><i class="fas fa-redo"></i> Current Status</h6>
                <div class="d-flex justify-content-between mb-2">
                  <span>Current Total:</span>
                  <strong>&#8377;<%= orderDetails.currentTotalPrice.toFixed(2) %></strong>
                </div>
                <div class="d-flex justify-content-between mb-2">
                  <span>Current Discount:</span>
                  <strong class="text-danger">-&#8377;<%= orderDetails.currentDiscount.toFixed(2) %></strong>
                </div>
                <div class="d-flex justify-content-between">
                  <span>Current Amount Due:</span>
                  <strong class="text-info">&#8377;<%= orderDetails.currentFinalAmount.toFixed(2) %></strong>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card border-info">
            <div class="card-header bg-info text-white">
              <h5 class="mb-0">Refund Information</h5>
            </div>
            <div class="card-body">
              <p><strong>Payment Method:</strong> <%= orderDetails.paymentMethod %></p>

              <% if (orderDetails.status === 'Cancelled') { %>
              <div class="d-flex justify-content-between mb-2">
                <span>Total Refunded:</span>
                <strong class="text-success">&#8377;<%= orderDetails.totalRefunded.toFixed(2) %></strong>
              </div>

              <% if (orderDetails.paymentMethod === 'prepaid' || orderDetails.paymentMethod === 'wallet') { %>
              <p><strong>Refund Status:</strong>
                <span class="badge bg-<%= orderDetails.moneySent ? 'success' : 'warning' %>">
                  <%= orderDetails.moneySent ? 'Fully Refunded' : 'Pending Refund' %>
                </span>
              </p>

              <% if (!orderDetails.moneySent && orderDetails.currentFinalAmount > 0) { %>
              <p class="text-warning">
                <i class="fas fa-exclamation-triangle"></i>
                Amount pending: &#8377;<%= orderDetails.currentFinalAmount.toFixed(2) %>
              </p>
              <% } %>
              <% } else { %>
              <p class="text-muted">No refund required for <%= orderDetails.paymentMethod %> orders</p>
              <% } %>

              <% } else if (orderDetails.partialRefunds && orderDetails.partialRefunds.length > 0) { %>
              <p><strong>Partial Refunds:</strong> <%= orderDetails.partialRefunds.length %> item(s)</p>
              <div class="d-flex justify-content-between">
                <span>Total Refunded:</span>
                <strong class="text-success">&#8377;<%= orderDetails.totalRefunded.toFixed(2) %></strong>
              </div>
              <p class="small text-muted mt-2">
                Remaining: &#8377;<%= orderDetails.currentFinalAmount.toFixed(2) %>
              </p>
              <% } else { %>
              <p class="text-muted">No refunds processed yet</p>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="text-center mb-5">
      <a href="/admin/orders" class="btn btn-outline-dark">
        <i class="fas fa-arrow-left"></i> Back to Orders
      </a>
    </div>
  </div>
</div>

<%- include('../../views/partials/admin/footer') %>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
  // Status update for entire order
  $(document).on("click", ".status-btn", function() {
    var orderId = $(this).data("id");
    var status = $(this).data("status");

    let confirmText = `Are you sure you want to mark this order as ${status}?`;
    let confirmButtonText = `Yes, ${status}!`;

    if (status === 'Cancelled') {
      confirmText = `Are you sure you want to cancel this entire order?`;
      confirmButtonText = 'Yes, Cancel Order!';
    }

    Swal.fire({
      title: confirmText,
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: confirmButtonText,
      cancelButtonText: "No, Cancel",
      reverseButtons: true,
      input: status === 'Cancelled' ? 'textarea' : null,
      inputPlaceholder: status === 'Cancelled' ? 'Please provide a reason for cancellation...' : '',
      inputAttributes: {
        'aria-label': 'Cancellation reason',
        'maxlength': 300
      },
      showLoaderOnConfirm: true,
      preConfirm: (cancelReason) => {
        if (status === 'Cancelled' && (!cancelReason || cancelReason.trim() === '')) {
          Swal.showValidationMessage('Please provide a cancellation reason');
          return false;
        }

        const requestData = {
          orderId: orderId,
          status: status
        };

        if (status === 'Cancelled' && cancelReason) {
          requestData.cancelReason = cancelReason;
        }

        return fetch("/admin/updateOrderStatus", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(requestData)
          })
          .then(response => response.json())
          .catch(error => {
            Swal.showValidationMessage(`Request failed: ${error}`);
          });
      }
    }).then((result) => {
      if (result.isConfirmed) {
        const response = result.value;
        if (response.success) {
          let successMessage = response.message;

          if (status === 'Cancelled' && response.refundAmount) {
            successMessage += `<br><br><strong>Refund Information:</strong><br>`;
            successMessage += `â€¢ Refund Amount: â‚¹${response.refundAmount.toFixed(2)}<br>`;
            successMessage += `â€¢ Refund method: User's wallet`;
          }

          Swal.fire({
            title: "Success!",
            html: successMessage,
            icon: "success",
            confirmButtonText: "OK",
            width: 500
          }).then(() => {
            location.reload();
          });
        } else {
          Swal.fire({
            icon: "error",
            title: "Error",
            text: response.message || "An error occurred. Please try again.",
          });
        }
      }
    });
  });

  // Individual item cancellation
  $(document).on("click", ".cancel-item-btn", function() {
    const orderId = $(this).data("order-id");
    const itemId = $(this).data("item-id");
    const productName = $(this).data("product-name");

    Swal.fire({
      title: `Cancel Item: ${productName}`,
      text: `Are you sure you want to cancel this specific item?`,
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Yes, cancel item!",
      cancelButtonText: "No, keep it",
      input: 'textarea',
      inputPlaceholder: 'Please provide a reason for cancelling this item...',
      inputAttributes: {
        'aria-label': 'Reason for cancelling item',
        'maxlength': 300
      },
      showLoaderOnConfirm: true,
      preConfirm: (cancelReason) => {
        if (!cancelReason || cancelReason.trim() === '') {
          Swal.showValidationMessage('You must provide a reason for cancelling');
          return false;
        }

        return fetch("/admin/cancel-item", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              orderId: orderId,
              itemId: itemId,
              cancelReason: cancelReason
            })
          })
          .then(response => response.json())
          .catch(error => {
            Swal.showValidationMessage(`Request failed: ${error}`);
          });
      }
    }).then((result) => {
      if (result.isConfirmed) {
        const response = result.value;
        if (response.success) {
          let htmlContent = `
            <div style="text-align: center;">
              <div style="margin-bottom: 15px;">
                <i class="fas fa-check-circle" style="font-size: 48px; color: #28a745;"></i>
                <h4 style="margin-top: 10px; color: #28a745;">Item Cancelled</h4>
                <p>${response.message}</p>
              </div>
          `;

          if (response.refundAmount && response.refundAmount > 0) {
            htmlContent += `
              <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                          color: white; padding: 20px; border-radius: 10px; margin: 15px 0;">
                <h5 style="margin: 0 0 10px 0;">ðŸ’° Refund Processed</h5>
                <p style="font-size: 24px; margin: 10px 0; font-weight: bold;">
                  â‚¹${response.refundAmount.toFixed(2)}
                </p>
                <p style="margin: 5px 0; font-size: 14px;">
                  Has been credited to user's wallet
                </p>
              </div>
              
              <div style="text-align: left; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 10px;">
                <p style="margin: 5px 0;"><strong>Updated Order Total:</strong> â‚¹${response.orderTotal.toFixed(2)}</p>
                <p style="margin: 5px 0;"><strong>Remaining Items:</strong> ${response.remainingItems}</p>
              </div>
            `;
          }

          htmlContent += `</div>`;

          Swal.fire({
            title: '',
            html: htmlContent,
            icon: 'success',
            confirmButtonText: 'Continue',
            confirmButtonColor: '#3085d6',
            width: '500px'
          }).then(() => {
            location.reload();
          });
        } else {
          Swal.fire({
            icon: "error",
            title: "Error",
            text: response.message || "Failed to cancel item.",
          });
        }
      }
    });
  });

  // Send money to wallet
  $(document).on("click", ".send-money-btn", function() {
    var orderId = $(this).data("id");

    Swal.fire({
      title: "Send Money to User's Wallet",
      text: "Are you sure you want to send the refund amount to the user's wallet?",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Yes, send money!",
      cancelButtonText: "No, Cancel",
      reverseButtons: true,
    }).then((result) => {
      if (result.isConfirmed) {
        $.ajax({
          type: "POST",
          url: "/admin/sendMoneyToWallet",
          data: {
            orderId: orderId
          },
          success: function(response) {
            if (response.success) {
              Swal.fire({
                icon: "success",
                title: response.message,
                showConfirmButton: false,
                timer: 1500,
              }).then(() => {
                location.reload();
              });
            } else {
              Swal.fire({
                icon: "error",
                title: "Error",
                text: response.message || "An error occurred while sending money.",
              });
            }
          },
          error: function() {
            Swal.fire({
              icon: "error",
              title: "Request Failed",
              text: "There was an issue connecting to the server.",
            });
          },
        });
      } else {
        Swal.fire("Cancelled", "Money sending was cancelled.", "info");
      }
    });
  });
</script>

<style>
  .order-info,
  .address-info,
  .action-buttons {
    background-color: #f9f9f9;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    padding: 20px;
    border-radius: 8px;
  }

  .table {
    margin-top: 20px;
    width: 100%;
    border-collapse: collapse;
  }

  .table th,
  .table td {
    padding: 12px;
    text-align: center;
    vertical-align: middle;
    border: 1px solid #dee2e6;
  }

  .table thead th {
    background-color: #343a40;
    color: white;
    border-color: #454d55;
  }

  .action-buttons .btn {
    margin: 5px;
    min-width: 150px;
    padding: 8px 16px;
  }

  .badge {
    font-size: 0.85em;
    padding: 0.4em 0.8em;
  }

  .card {
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    border: none;
  }

  .card-header {
    font-weight: bold;
  }

  .cancel-item-btn {
    font-size: 0.85rem;
    padding: 0.25rem 0.5rem;
  }

  .img-fluid {
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }
</style>
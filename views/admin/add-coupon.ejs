<%- include('../../views/partials/admin/header') %>

<div class="wrapper">
  <%- include('../../views/partials/admin/sidebar') %>

  <div class="container">
    <h1 class="my-4">Add New Coupon</h1>

    <form id="addCouponForm" method="POST" enctype="multipart/form-data">
      <div class="form-group mb-3">
        <label for="name">Coupon Name</label>
        <input type="text" class="form-control" id="name" name="name" required placeholder="Enter coupon name" />
      </div>

      <div class="form-group mb-3">
        <label for="expireOn">Expiration Date</label>
        <input type="datetime-local" class="form-control" id="expireOn" name="expireOn" required />
      </div>

      <div class="form-group mb-3">
        <label for="offerPrice">Offer Price / Discount Amount</label>
        <input type="number" class="form-control" id="offerPrice" name="offerPrice" required min="1" placeholder="Enter discount amount (e.g., 50)" />
        <small class="form-text text-muted">This is the discount amount that will be applied.</small>
  </div>

  <div class="form-group mb-3">
    <label for="minPurchaseAmount">Minimum Purchase Amount</label>
    <input type="number" class="form-control" id="minPurchaseAmount" name="minPurchaseAmount" required min="1" placeholder="Enter minimum cart total (e.g., 100)" />
    <small class="form-text text-muted">Cart total must be equal to or greater than this amount to use the coupon.</small>
    <small class="form-text text-warning"><strong>Important:</strong> Must be greater than the offer price above.</small>
  </div>

  <button type="submit" class="btn btn-primary">Add Coupon</button>
  <a href="/admin/coupons" class="btn btn-danger">Cancel</a>
  </form>
</div>
</div>

<%- include('../../views/partials/admin/footer') %>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
  $("#addCouponForm").submit(function(e) {
    e.preventDefault();

    var formData = {
      name: $("#name").val(),
      expireOn: $("#expireOn").val(),
      offerPrice: parseFloat($("#offerPrice").val()),
      minPurchaseAmount: parseFloat($("#minPurchaseAmount").val()),
    };

    // Check for empty fields
    if (
      !formData.name ||
      !formData.expireOn ||
      !formData.offerPrice ||
      !formData.minPurchaseAmount
    ) {
      Swal.fire({
        icon: "error",
        title: "All fields are required!",
        text: "Please fill in all the fields.",
      });
      return;
    }

    // Check if expiration date is valid
    var expireDate = new Date(formData.expireOn);
    if (isNaN(expireDate)) {
      Swal.fire({
        icon: "error",
        title: "Invalid expiration date",
        text: "Please enter a valid expiration date.",
      });
      return;
    }

    // Check if expiration date is in the future
    var currentDate = new Date();
    if (expireDate <= currentDate) {
      Swal.fire({
        icon: "error",
        title: "Expiration Date Must Be in the Future",
        text: "The expiration date you entered is not valid. Please select a future date.",
      });
      return;
    }

    // Validate numerical values
    if (formData.offerPrice <= 0) {
      Swal.fire({
        icon: "error",
        title: "Invalid Offer Price",
        text: "Offer price must be a positive number.",
      });
      return;
    }

    if (formData.minPurchaseAmount <= 0) {
      Swal.fire({
        icon: "error",
        title: "Invalid Minimum Purchase Amount",
        text: "Minimum purchase amount must be a positive number.",
      });
      return;
    }

    // CRITICAL: Validate that minPurchaseAmount > offerPrice
    if (formData.minPurchaseAmount <= formData.offerPrice) {
      Swal.fire({
        icon: "error",
        title: "Invalid Amounts",
        html: `
          <div style="text-align: left;">
            <p><strong>Validation Error:</strong></p>
            <p>• Minimum purchase amount (₹${formData.minPurchaseAmount})</p>
            <p>• Offer price/discount (₹${formData.offerPrice})</p>
            <p><strong>Rule:</strong> Minimum purchase amount must be <strong>greater than</strong> the offer price.</p>
            <p><strong>Example:</strong> If offer is ₹50 discount, minimum purchase should be ₹100 or more.</p>
          </div>
        `,
      });
      return;
    }

    // Show summary before submission
    Swal.fire({
      title: 'Coupon Summary',
      html: `
        <div style="text-align: left; padding: 10px;">
          <p><strong>Coupon Name:</strong> ${formData.name}</p>
          <p><strong>Expires On:</strong> ${new Date(formData.expireOn).toLocaleString()}</p>
          <p><strong>Offer/Discount:</strong> ₹${formData.offerPrice}</p>
          <p><strong>Minimum Purchase Required:</strong> ₹${formData.minPurchaseAmount}</p>
          <hr>
          <p><strong>How it works:</strong></p>
          <p>• User gets ₹${formData.offerPrice} discount</p>
          <p>• When their cart total is ₹${formData.minPurchaseAmount} or more</p>
        </div>
      `,
      icon: 'info',
      showCancelButton: true,
      confirmButtonText: 'Yes, Create Coupon',
      cancelButtonText: 'Review Details'
    }).then((result) => {
      if (result.isConfirmed) {
        // Send the form data via AJAX POST
        $.ajax({
          type: "POST",
          url: "/admin/add-coupon",
          data: {
            name: formData.name,
            expireOn: formData.expireOn,
            offerPrice: formData.offerPrice,
            minPurchaseAmount: formData.minPurchaseAmount
          },
          success: function(response) {
            if (response.success) {
              Swal.fire({
                icon: "success",
                title: "Coupon Added",
                text: response.message || "The coupon has been added successfully.",
              }).then(() => {
                window.location.href = "/admin/coupons";
              });
            } else {
              Swal.fire({
                icon: "error",
                title: "Error",
                text: response.message || "There was an issue adding the coupon.",
              });
            }
          },
          error: function() {
            Swal.fire({
              icon: "error",
              title: "Server Error",
              text: "There was an issue connecting to the server.",
            });
          },
        });
      }
    });
  });
</script>
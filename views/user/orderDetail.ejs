<%- include('../../views/partials/user/header') %>

<div class="ml-5">
  <!-- Breadcrumbs -->
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="/">Home</a></li>
      <li class="breadcrumb-item"><a href="/userProfile">Profile</a></li>
      <li class="breadcrumb-item">
        <a href="/userProfile?section=orders">Order</a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">Order Details</li>
    </ol>
  </nav>
</div>

<div class="container mt-4 mb-5">
  <h3 class="text-center">Order Details</h3>
  <h5 class="text-black-50 my-2">Id: <%= order._id %></h5>
  <p class="text-center">
    <strong>Placed on:</strong> <%= new Date(order.createdOn).toLocaleDateString() %>
  </p>

  <div class="d-flex justify-content-center">
    <div class="col-12 col-md-8">
      <% order.ordereditems.forEach(item => { %>
      <div class="card mb-4 shadow p-2" style="width: 100%; max-width: 900px">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-2">
              <a href="/product-details?id=<%= item.product._id %>">
                <img src="<%= item.product.productImage[0] %>" alt="<%= item.product.productName %>" class="img-fluid" style="max-height: 80px; width: auto"/>
              </a>
            </div>
            <div class="col-5">
              <a href="/product-details?id=<%= item.product._id %>">
                <p><%= item.product.productName %></p>
              </a>
              <p>Price: â‚¹<%= item.price %></p>
            </div>
            <div class="col-3 text-end">
              <div class="text-end justify-content-center">
                <% let statusColor = 'gray'; if (order.status === 'Delivered') { statusColor = 'green'; } else if (order.status === 'Processing') { statusColor = 'yellow'; } else if (order.status === 'Cancelled') { statusColor = 'red'; } %>
                <span class="status-dot" style="background-color: <%= statusColor %>; border-radius: 50%; display: inline-block; width: 15px; height: 15px; margin-top: 10px;"></span>
                <span class="card-text ml-3"><%= order.status %></span>

                <!-- Cancel Order Button -->
                <% if (order.status === 'Processing' || order.status === 'Pending') { %>
                  <button class="btn btn-danger mt-3 cancel-order-btn" data-order-id="<%= order._id %>">Cancel Order</button>
                <% } %>

                <!-- Rate and Review Link -->
                <% if (order.status === 'Delivered') { %>
                  <% 
                    const review = reviews.find(r => r.productId.toString() === item.product._id.toString());
                    if (review && !review.existingReview) { 
                  %>
                    <p>
                      <a href="/profile/order/<%= order._id %>/review?product_id=<%= item.product._id %>" class="mt-4 text-muted fw-bolder">Rate & Review</a>
                    </p>
                  <% 
                    } else if (review && review.existingReview) { 
                  %>
                    <p class="text-warning" style="font-size: 13px">Already reviewed</p>
                  <% } %>
                <% } %>
              </div>
            </div>
          </div>
        </div>
      </div>
      <% }) %>
    </div>
  </div>
</div>

<%- include('../../views/partials/user/footer') %>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
  // Handle cancel order action with SweetAlert confirmation
  $('.cancel-order-btn').on('click', function () {
    const orderId = $(this).data('order-id');
    
    Swal.fire({
      title: 'Are you sure?',
      text: 'Do you want to cancel this order?',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Yes, cancel it!',
      cancelButtonText: 'No, keep it'
    }).then((result) => {
      if (result.isConfirmed) {
        // Proceed with canceling the order
        $.ajax({
          url: `/order/cancel/${orderId}`,
          method: 'POST',
          success: function (response) {
            if (response.success) {
              Swal.fire('Cancelled!', 'Your order has been cancelled.', 'success').then(() => {
                location.reload(); // Reload the page to reflect the change
              });
            } else {
              Swal.fire('Error!', response.message, 'error');
            }
          },
          error: function () {
            Swal.fire('Error!', 'An error occurred while cancelling the order. Please try again.', 'error');
          }
        });
      }
    });
  });
</script>

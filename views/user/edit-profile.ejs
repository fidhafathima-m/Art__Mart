<head>
    <style>
      .sidebar a.active {
        background-color: #007bff;
        color: white;
      }
  
      .sidebar a.active i {
        color: white;  
      }
  
      .sidebar {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        width: 50px;
        background-color: #f8f9fa;
        padding-top: 20px;
        margin-bottom: 30px;
      }
  
      .sidebar a {
        display: block;
        padding: 10px 15px;
        color: #000;
        text-decoration: none;
        margin-bottom: 10px;
      }
  
      .sidebar a:hover {
        background-color: #007bff;
        color: white;
      }
  
      .alert {
        margin-top: 20px;
      }
    </style>
  </head>

<%- include('../../views/partials/user/header') %>

<div class="wrapper">
  <div class="row">
    <%- include('../../views/partials/user/sidebar', { currentPage: currentPage }) %>

    <div class="ml-5 col-md-8">
      <h2 class="mt-4 text-center mb-4">Edit Profile</h2>

      <!-- Edit Profile Form -->
      <form id="editProfileForm">
        <div class="card mb-4">
          <div class="card-body p-3">
            <div class="form-group">
              <label for="name">Full Name</label>
              <input
                type="text"
                class="form-control"
                id="name"
                name="name"
                value="<%= user.name %>"  
                required
              />
            </div>

            <div class="form-group mt-3">
              <label for="phone">Phone Number</label>
              <input
                type="text"
                class="form-control"
                id="phone"
                name="phone"
                value="<%= user.phone || '' %>" 
              />
            </div>

            <div class="mt-4">
              <button type="submit" class="btn btn-success">Save Changes</button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<%- include('../../views/partials/user/footer') %>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  // Submit the form via AJAX
  $('#editProfileForm').on('submit', function (e) {
    e.preventDefault(); // Prevent the form from submitting normally

    // Clear any previous error messages
    $('.error').remove();

    const name = $('#name').val();
    const phone = $('#phone').val();

    // Validation logic
    let isValid = true;

    // Validate name
    if (name.trim() === "") {
      isValid = false;
      $('#name').after('<span class="error text-danger">Name is required</span>');
    }

    // Validate phone (Optional: Simple validation to check if phone number contains only digits and is of a reasonable length)
    const phoneRegex = /^[0-9]{10}$/;
    if (phone.trim() !== "" && !phoneRegex.test(phone)) {
      isValid = false;
      $('#phone').after('<span class="error text-danger">Please enter a valid phone number</span>');
    }

    // If validation fails, do not submit the form
    if (!isValid) {
      return;
    }

    // Serialize the form data
    const formData = $(this).serialize();

    $.ajax({
      url: '/profile/edit', // Make an AJAX request to the backend
      method: 'POST',
      data: formData,
      success: function (response) {
        if (response.success) {
          // Show a success alert with SweetAlert
          Swal.fire({
            title: 'Success!',
            text: response.message,
            icon: 'success',
            confirmButtonText: 'OK',
          }).then((result) => {
            if (result.isConfirmed) {
              // Redirect to profile page after closing the alert
              window.location.href = '/userProfile?section=dashboard';
            }
          });
        } else {
          // Show an error alert with SweetAlert
          Swal.fire({
            title: 'Error!',
            text: response.message,
            icon: 'error',
            confirmButtonText: 'OK',
          });
        }
      },
      error: function () {
        // Show an error alert if the AJAX request fails
        Swal.fire({
          title: 'Error!',
          text: 'An unexpected error occurred. Please try again later.',
          icon: 'error',
          confirmButtonText: 'OK',
        });
      }
    });
  });
</script>
